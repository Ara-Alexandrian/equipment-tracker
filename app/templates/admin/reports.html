{% extends 'base.html' %}

{% block title %}Report Generator - Admin - Equipment Tracker{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h1>Report Generator</h1>
        <p class="lead">Generate equipment reports for audits, reviews, and analysis.</p>
    </div>
    <div class="col-md-4 text-end">
        <a href="{{ url_for('checkout.admin') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Admin
        </a>
    </div>
</div>

<div class="row">
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Report Options</h5>
            </div>
            <div class="card-body">
                <form id="reportForm" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="mb-3">
                        <label for="report_type" class="form-label">Report Type</label>
                        <select class="form-select" id="report_type" name="report_type" required>
                            <option value="inventory">Complete Inventory</option>
                            <option value="calibration">Calibration Status</option>
                            <option value="maintenance">Maintenance History</option>
                            <option value="checkout">Checkout History</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="report_format" class="form-label">Output Format</label>
                        <select class="form-select" id="report_format" name="report_format" required>
                            <option value="pdf">PDF</option>
                            <option value="excel">Excel</option>
                            <option value="csv">CSV</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="date_range" class="form-label">Date Range</label>
                        <select class="form-select" id="date_range" name="date_range" required>
                            <option value="all">All Time</option>
                            <option value="year">Past Year</option>
                            <option value="quarter">Past Quarter</option>
                            <option value="month">Past Month</option>
                            <option value="week">Past Week</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>
                    
                    <div id="custom_date_range" style="display: none;">
                        <div class="mb-3">
                            <label for="start_date" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="start_date" name="start_date">
                        </div>
                        <div class="mb-3">
                            <label for="end_date" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="end_date" name="end_date">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Include Fields</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="include_fields_metadata" name="include_fields[]" value="metadata" checked>
                            <label class="form-check-label" for="include_fields_metadata">
                                Report Metadata (date, time, generated by)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="include_fields_summary" name="include_fields[]" value="summary" checked>
                            <label class="form-check-label" for="include_fields_summary">
                                Statistical Summary
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="include_fields_details" name="include_fields[]" value="details" checked>
                            <label class="form-check-label" for="include_fields_details">
                                Detailed Information
                            </label>
                        </div>
                    </div>
                    
                    <div id="reportFormStatus" class="alert alert-info d-none">
                        <span id="reportFormStatusMessage">Generating report...</span>
                        <div class="progress mt-2">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                        </div>
                    </div>
                    
                    <button type="button" id="generateReportBtn" class="btn btn-primary w-100">
                        <i class="bi bi-file-earmark-pdf"></i> Generate Report
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-8 mb-4">
        <div class="card h-100">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">Recent Reports</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Report history will be displayed here once reports are generated.
                </div>
                
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date Generated</th>
                                <th>Report Type</th>
                                <th>Format</th>
                                <th>Generated By</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="5" class="text-center">No reports generated yet</td>
                            </tr>
                            <!-- Report history will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5>Report Templates</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <i class="bi bi-list-check text-primary me-2"></i> Inventory Report
                                </h5>
                                <p class="card-text">Complete inventory list with detailed equipment information.</p>
                                <button class="btn btn-sm btn-outline-primary w-100" data-report-type="inventory">
                                    Use Template
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <i class="bi bi-calendar-check text-success me-2"></i> Calibration Status
                                </h5>
                                <p class="card-text">Report on calibration status, due dates, and overdue items.</p>
                                <button class="btn btn-sm btn-outline-success w-100" data-report-type="calibration">
                                    Use Template
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <i class="bi bi-geo-alt text-danger me-2"></i> Location Report
                                </h5>
                                <p class="card-text">Equipment categorized by location with status information.</p>
                                <button class="btn btn-sm btn-outline-danger w-100" data-report-type="location">
                                    Use Template
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Show/hide custom date range when date range is changed
        const dateRangeSelect = document.getElementById('date_range');
        const customDateRange = document.getElementById('custom_date_range');
        
        dateRangeSelect.addEventListener('change', function() {
            if (this.value === 'custom') {
                customDateRange.style.display = 'block';
            } else {
                customDateRange.style.display = 'none';
            }
        });
        
        // Use template buttons to pre-fill form
        const templateButtons = document.querySelectorAll('[data-report-type]');
        templateButtons.forEach(button => {
            button.addEventListener('click', function() {
                const reportType = this.getAttribute('data-report-type');
                document.getElementById('report_type').value = reportType;
                
                // Scroll to form
                document.querySelector('.card-header.bg-primary').scrollIntoView({
                    behavior: 'smooth'
                });
            });
        });
        
        // Handle report generation
        document.getElementById('generateReportBtn').addEventListener('click', function() {
            // Update status message
            const reportFormStatus = document.getElementById('reportFormStatus');
            reportFormStatus.classList.remove('d-none');
            
            // Get form data
            const form = document.getElementById('reportForm');
            const formData = new FormData(form);
            
            // Send request to generate report
            fetch('/reports/generate', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Hide status message
                reportFormStatus.classList.add('d-none');
                
                if (data.status === 'success') {
                    // PDF report
                    if (data.html) {
                        const win = window.open('', '_blank');
                        win.document.write(data.html);
                        win.document.close();
                        win.focus();
                    }
                    
                    // CSV/Excel report
                    if (data.csv) {
                        const blob = new Blob([data.csv], { type: 'text/csv' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = data.filename || 'report.csv';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }
                    
                    // Show success message
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success mt-3';
                    alertDiv.innerHTML = '<i class="bi bi-check-circle-fill"></i> Report generated successfully!';
                    form.appendChild(alertDiv);
                    
                    // Remove alert after 3 seconds
                    setTimeout(() => {
                        alertDiv.remove();
                    }, 3000);
                } else {
                    // Show error message
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-danger mt-3';
                    alertDiv.innerHTML = `<i class="bi bi-exclamation-triangle-fill"></i> ${data.error || 'Error generating report'}`;
                    form.appendChild(alertDiv);
                }
            })
            .catch(error => {
                // Hide status message
                reportFormStatus.classList.add('d-none');
                
                // Show error message
                console.error('Error:', error);
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-danger mt-3';
                alertDiv.innerHTML = `<i class="bi bi-exclamation-triangle-fill"></i> Error: ${error.message}`;
                form.appendChild(alertDiv);
            });
        });
    });
</script>
{% endblock %}