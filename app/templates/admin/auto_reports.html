{% extends 'base.html' %}

{% block title %}Automatic Reports - GearVue{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h1 class="mb-3">Automatic Report Settings</h1>
            <p class="lead">Configure settings for automatically generated equipment reports.</p>
        </div>
    </div>

    <!-- Configuration Tabs -->
    <ul class="nav nav-tabs" id="reportTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button" role="tab" aria-controls="general" aria-selected="true">
                General Settings
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="schedules-tab" data-bs-toggle="tab" data-bs-target="#schedules" type="button" role="tab" aria-controls="schedules" aria-selected="false">
                Schedules
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="email-tab" data-bs-toggle="tab" data-bs-target="#email" type="button" role="tab" aria-controls="email" aria-selected="false">
                Email Distribution
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="storage-tab" data-bs-toggle="tab" data-bs-target="#storage" type="button" role="tab" aria-controls="storage" aria-selected="false">
                Storage
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports" type="button" role="tab" aria-controls="reports" aria-selected="false">
                Generated Reports
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content p-4 border border-top-0 rounded-bottom bg-white" id="reportTabsContent">
        <!-- General Settings Tab -->
        <div class="tab-pane fade show active" id="general" role="tabpanel" aria-labelledby="general-tab">
            <form id="generalSettingsForm">
                <div class="form-check form-switch mb-4">
                    <input class="form-check-input" type="checkbox" id="autoReportsEnabled" {% if config.enabled %}checked{% endif %}>
                    <label class="form-check-label" for="autoReportsEnabled">
                        <strong>Enable Automatic Reports</strong>
                    </label>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Status</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <h6 class="mb-0">Scheduler Status</h6>
                                <small class="text-muted">Current state of the automatic report scheduler</small>
                            </div>
                            <span class="badge {% if is_running %}bg-success{% else %}bg-secondary{% endif %} p-2">
                                {% if is_running %}Running{% else %}Stopped{% endif %}
                            </span>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <h6 class="mb-0">Next Daily Report</h6>
                                <small class="text-muted">Next scheduled daily report generation</small>
                            </div>
                            <span id="nextDailyReport">{{ next_daily|default('Not scheduled') }}</span>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <h6 class="mb-0">Next Weekly Report</h6>
                                <small class="text-muted">Next scheduled weekly report generation</small>
                            </div>
                            <span id="nextWeeklyReport">{{ next_weekly|default('Not scheduled') }}</span>
                        </div>

                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0">Next Monthly Report</h6>
                                <small class="text-muted">Next scheduled monthly report generation</small>
                            </div>
                            <span id="nextMonthlyReport">{{ next_monthly|default('Not scheduled') }}</span>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-primary" id="startSchedulerBtn" {% if is_running %}disabled{% endif %}>
                                <i class="bi bi-play-fill"></i> Start Scheduler
                            </button>
                            <button type="button" class="btn btn-secondary" id="stopSchedulerBtn" {% if not is_running %}disabled{% endif %}>
                                <i class="bi bi-stop-fill"></i> Stop Scheduler
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Manual Report Generation</h5>
                    </div>
                    <div class="card-body">
                        <p>Generate reports manually with the current settings:</p>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="form-floating">
                                    <select class="form-select" id="manualReportType">
                                        <option value="inventory">Inventory</option>
                                        <option value="checkout">Checkout</option>
                                        <option value="calibration">Calibration</option>
                                        <option value="maintenance">Maintenance</option>
                                    </select>
                                    <label for="manualReportType">Report Type</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-floating">
                                    <select class="form-select" id="manualReportFormat">
                                        <option value="pdf">PDF</option>
                                        <option value="csv">CSV</option>
                                        <option value="excel">Excel</option>
                                    </select>
                                    <label for="manualReportFormat">Report Format</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <button type="button" class="btn btn-primary h-100 w-100" id="generateReportBtn">
                                    <i class="bi bi-file-earmark-text"></i> Generate Report
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Schedules Tab -->
        <div class="tab-pane fade" id="schedules" role="tabpanel" aria-labelledby="schedules-tab">
            <div class="accordion" id="schedulesAccordion">
                <!-- Daily Schedule -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="dailyHeading">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#dailyCollapse" aria-expanded="true" aria-controls="dailyCollapse">
                            Daily Reports
                        </button>
                    </h2>
                    <div id="dailyCollapse" class="accordion-collapse collapse show" aria-labelledby="dailyHeading" data-bs-parent="#schedulesAccordion">
                        <div class="accordion-body">
                            <form id="dailyScheduleForm">
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="dailyEnabled" {% if config.schedules.daily.enabled %}checked{% endif %}>
                                    <label class="form-check-label" for="dailyEnabled">
                                        <strong>Enable Daily Reports</strong>
                                    </label>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="dailyTime" class="form-label">Generation Time</label>
                                        <input type="time" class="form-control" id="dailyTime" value="{{ config.schedules.daily.time }}">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Email Distribution</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="dailyEmailEnabled" {% if config.schedules.daily.email_distribution %}checked{% endif %}>
                                            <label class="form-check-label" for="dailyEmailEnabled">
                                                Send reports via email
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Report Types</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="dailyInventory" {% if 'inventory' in config.schedules.daily.reports %}checked{% endif %}>
                                            <label class="form-check-label" for="dailyInventory">Inventory</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="dailyCheckout" {% if 'checkout' in config.schedules.daily.reports %}checked{% endif %}>
                                            <label class="form-check-label" for="dailyCheckout">Checkout</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="dailyCalibration" {% if 'calibration' in config.schedules.daily.reports %}checked{% endif %}>
                                            <label class="form-check-label" for="dailyCalibration">Calibration</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="dailyMaintenance" {% if 'maintenance' in config.schedules.daily.reports %}checked{% endif %}>
                                            <label class="form-check-label" for="dailyMaintenance">Maintenance</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Report Formats</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="dailyPdf" {% if 'pdf' in config.schedules.daily.formats %}checked{% endif %}>
                                            <label class="form-check-label" for="dailyPdf">PDF</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="dailyCsv" {% if 'csv' in config.schedules.daily.formats %}checked{% endif %}>
                                            <label class="form-check-label" for="dailyCsv">CSV</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="dailyExcel" {% if 'excel' in config.schedules.daily.formats %}checked{% endif %}>
                                            <label class="form-check-label" for="dailyExcel">Excel</label>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Weekly Schedule -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="weeklyHeading">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#weeklyCollapse" aria-expanded="false" aria-controls="weeklyCollapse">
                            Weekly Reports
                        </button>
                    </h2>
                    <div id="weeklyCollapse" class="accordion-collapse collapse" aria-labelledby="weeklyHeading" data-bs-parent="#schedulesAccordion">
                        <div class="accordion-body">
                            <form id="weeklyScheduleForm">
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="weeklyEnabled" {% if config.schedules.weekly.enabled %}checked{% endif %}>
                                    <label class="form-check-label" for="weeklyEnabled">
                                        <strong>Enable Weekly Reports</strong>
                                    </label>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="weeklyDay" class="form-label">Day of Week</label>
                                        <select class="form-select" id="weeklyDay">
                                            <option value="Monday" {% if config.schedules.weekly.day == 'Monday' %}selected{% endif %}>Monday</option>
                                            <option value="Tuesday" {% if config.schedules.weekly.day == 'Tuesday' %}selected{% endif %}>Tuesday</option>
                                            <option value="Wednesday" {% if config.schedules.weekly.day == 'Wednesday' %}selected{% endif %}>Wednesday</option>
                                            <option value="Thursday" {% if config.schedules.weekly.day == 'Thursday' %}selected{% endif %}>Thursday</option>
                                            <option value="Friday" {% if config.schedules.weekly.day == 'Friday' %}selected{% endif %}>Friday</option>
                                            <option value="Saturday" {% if config.schedules.weekly.day == 'Saturday' %}selected{% endif %}>Saturday</option>
                                            <option value="Sunday" {% if config.schedules.weekly.day == 'Sunday' %}selected{% endif %}>Sunday</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="weeklyTime" class="form-label">Generation Time</label>
                                        <input type="time" class="form-control" id="weeklyTime" value="{{ config.schedules.weekly.time }}">
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Report Types</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="weeklyInventory" {% if 'inventory' in config.schedules.weekly.reports %}checked{% endif %}>
                                            <label class="form-check-label" for="weeklyInventory">Inventory</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="weeklyCheckout" {% if 'checkout' in config.schedules.weekly.reports %}checked{% endif %}>
                                            <label class="form-check-label" for="weeklyCheckout">Checkout</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="weeklyCalibration" {% if 'calibration' in config.schedules.weekly.reports %}checked{% endif %}>
                                            <label class="form-check-label" for="weeklyCalibration">Calibration</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="weeklyMaintenance" {% if 'maintenance' in config.schedules.weekly.reports %}checked{% endif %}>
                                            <label class="form-check-label" for="weeklyMaintenance">Maintenance</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Report Formats</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="weeklyPdf" {% if 'pdf' in config.schedules.weekly.formats %}checked{% endif %}>
                                            <label class="form-check-label" for="weeklyPdf">PDF</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="weeklyCsv" {% if 'csv' in config.schedules.weekly.formats %}checked{% endif %}>
                                            <label class="form-check-label" for="weeklyCsv">CSV</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="weeklyExcel" {% if 'excel' in config.schedules.weekly.formats %}checked{% endif %}>
                                            <label class="form-check-label" for="weeklyExcel">Excel</label>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="weeklyEmailEnabled" {% if config.schedules.weekly.email_distribution %}checked{% endif %}>
                                    <label class="form-check-label" for="weeklyEmailEnabled">
                                        Send reports via email
                                    </label>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Monthly Schedule -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="monthlyHeading">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#monthlyCollapse" aria-expanded="false" aria-controls="monthlyCollapse">
                            Monthly Reports
                        </button>
                    </h2>
                    <div id="monthlyCollapse" class="accordion-collapse collapse" aria-labelledby="monthlyHeading" data-bs-parent="#schedulesAccordion">
                        <div class="accordion-body">
                            <form id="monthlyScheduleForm">
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="monthlyEnabled" {% if config.schedules.monthly.enabled %}checked{% endif %}>
                                    <label class="form-check-label" for="monthlyEnabled">
                                        <strong>Enable Monthly Reports</strong>
                                    </label>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="monthlyDay" class="form-label">Day of Month</label>
                                        <select class="form-select" id="monthlyDay">
                                            {% for day in range(1, 29) %}
                                            <option value="{{ day }}" {% if config.schedules.monthly.day == day %}selected{% endif %}>{{ day }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="monthlyTime" class="form-label">Generation Time</label>
                                        <input type="time" class="form-control" id="monthlyTime" value="{{ config.schedules.monthly.time }}">
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Report Types</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="monthlyInventory" {% if 'inventory' in config.schedules.monthly.reports %}checked{% endif %}>
                                            <label class="form-check-label" for="monthlyInventory">Inventory</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="monthlyCheckout" {% if 'checkout' in config.schedules.monthly.reports %}checked{% endif %}>
                                            <label class="form-check-label" for="monthlyCheckout">Checkout</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="monthlyCalibration" {% if 'calibration' in config.schedules.monthly.reports %}checked{% endif %}>
                                            <label class="form-check-label" for="monthlyCalibration">Calibration</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="monthlyMaintenance" {% if 'maintenance' in config.schedules.monthly.reports %}checked{% endif %}>
                                            <label class="form-check-label" for="monthlyMaintenance">Maintenance</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Report Formats</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="monthlyPdf" {% if 'pdf' in config.schedules.monthly.formats %}checked{% endif %}>
                                            <label class="form-check-label" for="monthlyPdf">PDF</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="monthlyCsv" {% if 'csv' in config.schedules.monthly.formats %}checked{% endif %}>
                                            <label class="form-check-label" for="monthlyCsv">CSV</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="monthlyExcel" {% if 'excel' in config.schedules.monthly.formats %}checked{% endif %}>
                                            <label class="form-check-label" for="monthlyExcel">Excel</label>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="monthlyEmailEnabled" {% if config.schedules.monthly.email_distribution %}checked{% endif %}>
                                    <label class="form-check-label" for="monthlyEmailEnabled">
                                        Send reports via email
                                    </label>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-4">
                <button type="button" class="btn btn-primary" id="saveSchedulesBtn">
                    <i class="bi bi-save"></i> Save Schedule Settings
                </button>
            </div>
        </div>

        <!-- Email Distribution Tab -->
        <div class="tab-pane fade" id="email" role="tabpanel" aria-labelledby="email-tab">
            <form id="emailSettingsForm">
                <div class="form-check form-switch mb-4">
                    <input class="form-check-input" type="checkbox" id="emailEnabled" {% if config.email.enabled %}checked{% endif %}>
                    <label class="form-check-label" for="emailEnabled">
                        <strong>Enable Email Distribution</strong>
                    </label>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Email Templates</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="emailSubjectPrefix" class="form-label">Email Subject Prefix</label>
                            <input type="text" class="form-control" id="emailSubjectPrefix" value="{{ config.email.subject_prefix }}">
                            <div class="form-text">This prefix will be added to all automated report email subjects.</div>
                        </div>

                        <div class="mb-3">
                            <label for="emailBodyTemplate" class="form-label">Email Body Template</label>
                            <textarea class="form-control" id="emailBodyTemplate" rows="4">{{ config.email.body_template }}</textarea>
                            <div class="form-text">
                                You can use {report_type} and {date_range} as placeholders that will be replaced with the actual values.
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Recipients</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <h6>Daily Reports</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="dailyRecipientPhysicists" {% if 'physicists' in config.email.recipients.daily %}checked{% endif %}>
                                    <label class="form-check-label" for="dailyRecipientPhysicists">Physicists</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="dailyRecipientAdmin" {% if 'admin' in config.email.recipients.daily %}checked{% endif %}>
                                    <label class="form-check-label" for="dailyRecipientAdmin">Administrators</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="dailyRecipientManagement" {% if 'management' in config.email.recipients.daily %}checked{% endif %}>
                                    <label class="form-check-label" for="dailyRecipientManagement">Management</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <h6>Weekly Reports</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="weeklyRecipientPhysicists" {% if 'physicists' in config.email.recipients.weekly %}checked{% endif %}>
                                    <label class="form-check-label" for="weeklyRecipientPhysicists">Physicists</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="weeklyRecipientAdmin" {% if 'admin' in config.email.recipients.weekly %}checked{% endif %}>
                                    <label class="form-check-label" for="weeklyRecipientAdmin">Administrators</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="weeklyRecipientManagement" {% if 'management' in config.email.recipients.weekly %}checked{% endif %}>
                                    <label class="form-check-label" for="weeklyRecipientManagement">Management</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <h6>Monthly Reports</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="monthlyRecipientPhysicists" {% if 'physicists' in config.email.recipients.monthly %}checked{% endif %}>
                                    <label class="form-check-label" for="monthlyRecipientPhysicists">Physicists</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="monthlyRecipientAdmin" {% if 'admin' in config.email.recipients.monthly %}checked{% endif %}>
                                    <label class="form-check-label" for="monthlyRecipientAdmin">Administrators</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="monthlyRecipientManagement" {% if 'management' in config.email.recipients.monthly %}checked{% endif %}>
                                    <label class="form-check-label" for="monthlyRecipientManagement">Management</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <button type="button" class="btn btn-primary" id="saveEmailSettingsBtn">
                    <i class="bi bi-save"></i> Save Email Settings
                </button>
            </form>
        </div>

        <!-- Storage Tab -->
        <div class="tab-pane fade" id="storage" role="tabpanel" aria-labelledby="storage-tab">
            <form id="storageSettingsForm">
                <div class="form-check form-switch mb-4">
                    <input class="form-check-input" type="checkbox" id="storageEnabled" {% if config.storage.enabled %}checked{% endif %}>
                    <label class="form-check-label" for="storageEnabled">
                        <strong>Enable Report Storage</strong>
                    </label>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Storage Configuration</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="storagePath" class="form-label">Storage Path</label>
                            <input type="text" class="form-control" id="storagePath" value="{{ config.storage.path }}">
                            <div class="form-text">Path where generated reports will be stored.</div>
                        </div>

                        <div class="mb-3">
                            <label for="retentionDays" class="form-label">Retention Period (Days)</label>
                            <input type="number" class="form-control" id="retentionDays" value="{{ config.storage.retention_days }}" min="1" max="3650">
                            <div class="form-text">Number of days to keep reports before automatic deletion. Set to 0 to keep indefinitely.</div>
                        </div>

                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="organizeByType" {% if config.storage.organize_by_type %}checked{% endif %}>
                            <label class="form-check-label" for="organizeByType">
                                Organize reports by type (create subdirectories for each report type)
                            </label>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Storage Statistics</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <h6 class="text-muted mb-2">Total Reports</h6>
                                        <h2 class="mb-0">{{ report_count|default('0') }}</h2>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <h6 class="text-muted mb-2">Storage Used</h6>
                                        <h2 class="mb-0">{{ storage_size|default('0 MB') }}</h2>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <h6 class="text-muted mb-2">Oldest Report</h6>
                                        <h2 class="mb-0">{{ oldest_report|default('None') }}</h2>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-auto">
                        <button type="button" class="btn btn-primary" id="saveStorageSettingsBtn">
                            <i class="bi bi-save"></i> Save Storage Settings
                        </button>
                    </div>
                    <div class="col-auto">
                        <button type="button" class="btn btn-danger" id="cleanupOldReportsBtn">
                            <i class="bi bi-trash"></i> Clean Up Old Reports
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Generated Reports Tab -->
        <div class="tab-pane fade" id="reports" role="tabpanel" aria-labelledby="reports-tab">
            <div class="mb-4">
                <div class="row align-items-center">
                    <div class="col">
                        <h5>Recent Generated Reports</h5>
                    </div>
                    <div class="col-auto">
                        <button type="button" class="btn btn-sm btn-primary" id="refreshReportsBtn">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Report Name</th>
                                    <th>Type</th>
                                    <th>Format</th>
                                    <th>Generated</th>
                                    <th>Size</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="reportsList">
                                {% if reports %}
                                    {% for report in reports %}
                                    <tr>
                                        <td>{{ report.name }}</td>
                                        <td>{{ report.type }}</td>
                                        <td>{{ report.format }}</td>
                                        <td>{{ report.generated }}</td>
                                        <td>{{ report.size }}</td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <a href="{{ url_for('admin.download_report', report_path=report.path) }}" class="btn btn-outline-primary">
                                                    <i class="bi bi-download"></i>
                                                </a>
                                                <button type="button" class="btn btn-outline-danger" onclick="deleteReport('{{ report.path }}')">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="6" class="text-center py-4">No reports have been generated yet.</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for auto report settings -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Save general settings
        document.getElementById('saveSchedulesBtn').addEventListener('click', function() {
            // Collect settings from form
            const data = {
                schedules: {
                    daily: {
                        enabled: document.getElementById('dailyEnabled').checked,
                        time: document.getElementById('dailyTime').value,
                        reports: [],
                        formats: [],
                        email_distribution: document.getElementById('dailyEmailEnabled').checked
                    },
                    weekly: {
                        enabled: document.getElementById('weeklyEnabled').checked,
                        day: document.getElementById('weeklyDay').value,
                        time: document.getElementById('weeklyTime').value,
                        reports: [],
                        formats: [],
                        email_distribution: document.getElementById('weeklyEmailEnabled').checked
                    },
                    monthly: {
                        enabled: document.getElementById('monthlyEnabled').checked,
                        day: parseInt(document.getElementById('monthlyDay').value),
                        time: document.getElementById('monthlyTime').value,
                        reports: [],
                        formats: [],
                        email_distribution: document.getElementById('monthlyEmailEnabled').checked
                    }
                }
            };
            
            // Collect report types for each frequency
            if (document.getElementById('dailyInventory').checked) data.schedules.daily.reports.push('inventory');
            if (document.getElementById('dailyCheckout').checked) data.schedules.daily.reports.push('checkout');
            if (document.getElementById('dailyCalibration').checked) data.schedules.daily.reports.push('calibration');
            if (document.getElementById('dailyMaintenance').checked) data.schedules.daily.reports.push('maintenance');
            
            if (document.getElementById('weeklyInventory').checked) data.schedules.weekly.reports.push('inventory');
            if (document.getElementById('weeklyCheckout').checked) data.schedules.weekly.reports.push('checkout');
            if (document.getElementById('weeklyCalibration').checked) data.schedules.weekly.reports.push('calibration');
            if (document.getElementById('weeklyMaintenance').checked) data.schedules.weekly.reports.push('maintenance');
            
            if (document.getElementById('monthlyInventory').checked) data.schedules.monthly.reports.push('inventory');
            if (document.getElementById('monthlyCheckout').checked) data.schedules.monthly.reports.push('checkout');
            if (document.getElementById('monthlyCalibration').checked) data.schedules.monthly.reports.push('calibration');
            if (document.getElementById('monthlyMaintenance').checked) data.schedules.monthly.reports.push('maintenance');
            
            // Collect formats for each frequency
            if (document.getElementById('dailyPdf').checked) data.schedules.daily.formats.push('pdf');
            if (document.getElementById('dailyCsv').checked) data.schedules.daily.formats.push('csv');
            if (document.getElementById('dailyExcel').checked) data.schedules.daily.formats.push('excel');
            
            if (document.getElementById('weeklyPdf').checked) data.schedules.weekly.formats.push('pdf');
            if (document.getElementById('weeklyCsv').checked) data.schedules.weekly.formats.push('csv');
            if (document.getElementById('weeklyExcel').checked) data.schedules.weekly.formats.push('excel');
            
            if (document.getElementById('monthlyPdf').checked) data.schedules.monthly.formats.push('pdf');
            if (document.getElementById('monthlyCsv').checked) data.schedules.monthly.formats.push('csv');
            if (document.getElementById('monthlyExcel').checked) data.schedules.monthly.formats.push('excel');
            
            // Send to server
            fetch('/admin/auto-reports/save-schedules', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Schedule settings saved successfully');
                } else {
                    alert('Error saving settings: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error saving settings:', error);
                alert('An error occurred while saving settings');
            });
        });
        
        // Save email settings
        document.getElementById('saveEmailSettingsBtn').addEventListener('click', function() {
            // Collect email settings
            const data = {
                email: {
                    enabled: document.getElementById('emailEnabled').checked,
                    subject_prefix: document.getElementById('emailSubjectPrefix').value,
                    body_template: document.getElementById('emailBodyTemplate').value,
                    recipients: {
                        daily: [],
                        weekly: [],
                        monthly: []
                    }
                }
            };
            
            // Collect recipients for each frequency
            if (document.getElementById('dailyRecipientPhysicists').checked) data.email.recipients.daily.push('physicists');
            if (document.getElementById('dailyRecipientAdmin').checked) data.email.recipients.daily.push('admin');
            if (document.getElementById('dailyRecipientManagement').checked) data.email.recipients.daily.push('management');
            
            if (document.getElementById('weeklyRecipientPhysicists').checked) data.email.recipients.weekly.push('physicists');
            if (document.getElementById('weeklyRecipientAdmin').checked) data.email.recipients.weekly.push('admin');
            if (document.getElementById('weeklyRecipientManagement').checked) data.email.recipients.weekly.push('management');
            
            if (document.getElementById('monthlyRecipientPhysicists').checked) data.email.recipients.monthly.push('physicists');
            if (document.getElementById('monthlyRecipientAdmin').checked) data.email.recipients.monthly.push('admin');
            if (document.getElementById('monthlyRecipientManagement').checked) data.email.recipients.monthly.push('management');
            
            // Send to server
            fetch('/admin/auto-reports/save-email', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Email settings saved successfully');
                } else {
                    alert('Error saving settings: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error saving settings:', error);
                alert('An error occurred while saving settings');
            });
        });
        
        // Save storage settings
        document.getElementById('saveStorageSettingsBtn').addEventListener('click', function() {
            // Collect storage settings
            const data = {
                storage: {
                    enabled: document.getElementById('storageEnabled').checked,
                    path: document.getElementById('storagePath').value,
                    retention_days: parseInt(document.getElementById('retentionDays').value),
                    organize_by_type: document.getElementById('organizeByType').checked
                }
            };
            
            // Send to server
            fetch('/admin/auto-reports/save-storage', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Storage settings saved successfully');
                } else {
                    alert('Error saving settings: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error saving settings:', error);
                alert('An error occurred while saving settings');
            });
        });
        
        // Scheduler controls
        document.getElementById('startSchedulerBtn').addEventListener('click', function() {
            fetch('/admin/auto-reports/start-scheduler', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        document.getElementById('startSchedulerBtn').disabled = true;
                        document.getElementById('stopSchedulerBtn').disabled = false;
                        alert('Scheduler started successfully');
                    } else {
                        alert('Error starting scheduler: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error starting scheduler:', error);
                    alert('An error occurred while starting the scheduler');
                });
        });
        
        document.getElementById('stopSchedulerBtn').addEventListener('click', function() {
            fetch('/admin/auto-reports/stop-scheduler', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        document.getElementById('startSchedulerBtn').disabled = false;
                        document.getElementById('stopSchedulerBtn').disabled = true;
                        alert('Scheduler stopped successfully');
                    } else {
                        alert('Error stopping scheduler: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error stopping scheduler:', error);
                    alert('An error occurred while stopping the scheduler');
                });
        });
        
        // Generate report manually
        document.getElementById('generateReportBtn').addEventListener('click', function() {
            const reportType = document.getElementById('manualReportType').value;
            const reportFormat = document.getElementById('manualReportFormat').value;
            
            fetch('/admin/auto-reports/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    report_type: reportType,
                    report_format: reportFormat
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Report generated successfully');
                    // Refresh the reports list
                    refreshReportsList();
                } else {
                    alert('Error generating report: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error generating report:', error);
                alert('An error occurred while generating the report');
            });
        });
        
        // Clean up old reports
        document.getElementById('cleanupOldReportsBtn').addEventListener('click', function() {
            if (confirm('Are you sure you want to delete all reports older than the retention period?')) {
                fetch('/admin/auto-reports/cleanup', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert('Old reports cleaned up successfully');
                            // Refresh the reports list
                            refreshReportsList();
                        } else {
                            alert('Error cleaning up reports: ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error cleaning up reports:', error);
                        alert('An error occurred while cleaning up reports');
                    });
            }
        });
        
        // Refresh reports list
        document.getElementById('refreshReportsBtn').addEventListener('click', refreshReportsList);
        
        function refreshReportsList() {
            fetch('/admin/auto-reports/list')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const reportsList = document.getElementById('reportsList');
                        
                        if (data.reports.length === 0) {
                            reportsList.innerHTML = `
                                <tr>
                                    <td colspan="6" class="text-center py-4">No reports have been generated yet.</td>
                                </tr>
                            `;
                            return;
                        }
                        
                        // Clear existing list
                        reportsList.innerHTML = '';
                        
                        // Add each report to the list
                        data.reports.forEach(report => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${report.name}</td>
                                <td>${report.type}</td>
                                <td>${report.format}</td>
                                <td>${report.generated}</td>
                                <td>${report.size}</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="/admin/auto-reports/download/${encodeURIComponent(report.path)}" class="btn btn-outline-primary">
                                            <i class="bi bi-download"></i>
                                        </a>
                                        <button type="button" class="btn btn-outline-danger" onclick="deleteReport('${report.path}')">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            `;
                            reportsList.appendChild(row);
                        });
                    } else {
                        console.error('Error fetching reports:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Error fetching reports:', error);
                });
        }
        
        // Delete report function (will be called from the delete button)
        window.deleteReport = function(reportPath) {
            if (confirm('Are you sure you want to delete this report?')) {
                fetch('/admin/auto-reports/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        report_path: reportPath
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Report deleted successfully');
                        // Refresh the reports list
                        refreshReportsList();
                    } else {
                        alert('Error deleting report: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error deleting report:', error);
                    alert('An error occurred while deleting the report');
                });
            }
        };
    });
</script>
{% endblock %}