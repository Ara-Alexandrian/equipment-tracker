{% extends 'base.html' %}

{% block title %}Equipment Edit Test - Admin{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <h1>Equipment Edit Form Test</h1>
        <p class="lead">This is a simplified test form for equipment editing.</p>
        <div class="alert alert-info">
            <p><strong>Testing Page:</strong> This page uses a direct approach to forms to test the edit functionality.</p>
        </div>
    </div>
</div>

<!-- Sample Equipment -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5>Sample Equipment Item</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>ID:</strong> Chamber-CNMC-123456</p>
                        <p><strong>Category:</strong> Chamber</p>
                        <p><strong>Type:</strong> ionization chamber</p>
                        <p><strong>Manufacturer:</strong> CNMC</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Model:</strong> TN30013</p>
                        <p><strong>Serial:</strong> 123456</p>
                        <p><strong>Location:</strong> Essen (BR)</p>
                        <p><strong>Calibration:</strong> 08/2025</p>
                    </div>
                </div>
                <div class="mt-3">
                    <button class="btn btn-primary" id="testEditBtn">
                        <i class="bi bi-pencil"></i> Test Edit Form
                    </button>
                    <button class="btn btn-info" id="testQRBtn">
                        <i class="bi bi-qr-code"></i> Test QR Generation
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="testEditModal" tabindex="-1" aria-labelledby="testEditModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="testEditModalLabel">Edit Test Equipment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="testEditForm" action="#" method="POST">
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="test_id" class="form-label">Equipment ID</label>
                            <input type="text" class="form-control" id="test_id" readonly>
                        </div>
                        <div class="col-md-6">
                            <label for="test_category" class="form-label">Category*</label>
                            <select class="form-select" id="test_category" name="category" required>
                                <option value="Chamber">Chamber</option>
                                <option value="Electrometer">Electrometer</option>
                                <option value="Survey Meter">Survey Meter</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="test_equipment_type" class="form-label">Equipment Type*</label>
                            <input type="text" class="form-control" id="test_equipment_type" name="equipment_type" required>
                        </div>
                        <div class="col-md-6">
                            <label for="test_manufacturer" class="form-label">Manufacturer*</label>
                            <input type="text" class="form-control" id="test_manufacturer" name="manufacturer" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="test_model" class="form-label">Model*</label>
                            <input type="text" class="form-control" id="test_model" name="model" required>
                        </div>
                        <div class="col-md-6">
                            <label for="test_serial_number" class="form-label">Serial Number*</label>
                            <input type="text" class="form-control" id="test_serial_number" name="serial_number" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="test_location" class="form-label">Location*</label>
                            <input type="text" class="form-control" id="test_location" name="location" required>
                        </div>
                        <div class="col-md-6">
                            <label for="test_calibration_due_date" class="form-label">Calibration Due Date*</label>
                            <input type="text" class="form-control" id="test_calibration_due_date" name="calibration_due_date" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="test_notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="test_notes" name="notes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-info me-2" id="test_generateQRBtn">
                        <i class="bi bi-qr-code"></i> Generate QR Code
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save"></i> Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- QR Code Modal -->
<div class="modal fade" id="testQRModal" tabindex="-1" aria-labelledby="testQRModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="testQRModalLabel">Test QR Code</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div id="testQRLoading" class="mb-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Generating QR code...</p>
                </div>
                <div id="testQRError" class="alert alert-danger" style="display: none;">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    Error generating QR code. Please ensure all required fields are filled.
                </div>
                <div id="testQRDisplay" style="display: none;">
                    <img id="testQRImage" src="" alt="Generated QR Code" class="img-fluid mb-3" style="max-width: 300px;">
                    <div class="mt-2">
                        <p class="mb-2"><strong id="testQREquipmentId">Equipment ID: </strong></p>
                        <p class="mb-2">Scan this QR code for quick access to equipment details, checkout, and maintenance.</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a id="testQRDownloadBtn" href="#" class="btn btn-primary" download="qr_code.png" style="display: none;">
                    <i class="bi bi-download"></i> Download QR Code
                </a>
                <button id="testQRPrintBtn" type="button" class="btn btn-outline-primary" style="display: none;">
                    <i class="bi bi-printer"></i> Print
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Debug Display -->
<div class="fixed-bottom m-3">
    <div id="debugOutput" class="alert alert-info" style="display: none;"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Enhanced debug function
    function debug(message, isPersistent = false) {
        console.log(message);
        const debugEl = document.getElementById('debugOutput');

        // If it's a string, just display it
        if (typeof message === 'string') {
            debugEl.textContent = message;
        } else {
            // If it's an object, pretty print it
            debugEl.innerHTML = '<pre>' + JSON.stringify(message, null, 2) + '</pre>';
        }

        debugEl.style.display = 'block';

        if (!isPersistent) {
            setTimeout(() => {
                debugEl.style.display = 'none';
            }, 10000); // Show for longer - 10 seconds
        }
    }

    // Function to check form values
    function checkFormValues() {
        const values = {
            id: document.getElementById('test_id').value,
            category: document.getElementById('test_category').value,
            equipment_type: document.getElementById('test_equipment_type').value,
            manufacturer: document.getElementById('test_manufacturer').value,
            model: document.getElementById('test_model').value,
            serial_number: document.getElementById('test_serial_number').value,
            location: document.getElementById('test_location').value,
            calibration_due_date: document.getElementById('test_calibration_due_date').value,
            notes: document.getElementById('test_notes').value
        };

        console.log('Current form values:', values);
        return values;
    }

    // Sample data
    const sampleData = {
        id: 'Chamber-CNMC-123456',
        category: 'Chamber',
        type: 'ionization chamber',
        manufacturer: 'CNMC',
        model: 'TN30013',
        serial: '123456',
        location: 'Essen (BR)',
        calibration: '08/2025',
        notes: 'Test notes for this equipment item.'
    };

    // Edit button handling with enhanced debugging
    document.getElementById('testEditBtn').addEventListener('click', function() {
        debug('Edit button clicked - populating form with test data', true);

        try {
            // Clear form first
            document.getElementById('test_id').value = '';
            document.getElementById('test_category').value = '';
            document.getElementById('test_equipment_type').value = '';
            document.getElementById('test_manufacturer').value = '';
            document.getElementById('test_model').value = '';
            document.getElementById('test_serial_number').value = '';
            document.getElementById('test_location').value = '';
            document.getElementById('test_calibration_due_date').value = '';
            document.getElementById('test_notes').value = '';

            // Check values after clearing
            debug('Form cleared. Current values: ' + JSON.stringify(checkFormValues(), null, 2));

            // Now populate the form - first with direct DOM assignments
            document.getElementById('test_id').value = sampleData.id;
            document.getElementById('test_category').value = sampleData.category;
            document.getElementById('test_equipment_type').value = sampleData.type;
            document.getElementById('test_manufacturer').value = sampleData.manufacturer;
            document.getElementById('test_model').value = sampleData.model;
            document.getElementById('test_serial_number').value = sampleData.serial;
            document.getElementById('test_location').value = sampleData.location;
            document.getElementById('test_calibration_due_date').value = sampleData.calibration;
            document.getElementById('test_notes').value = sampleData.notes;

            // Check values after DOM assignments
            debug('After DOM assignments. Current values: ' + JSON.stringify(checkFormValues(), null, 2));

            // Now try using jQuery
            $('#test_id').val(sampleData.id);
            $('#test_category').val(sampleData.category);
            $('#test_equipment_type').val(sampleData.type);
            $('#test_manufacturer').val(sampleData.manufacturer);
            $('#test_model').val(sampleData.model);
            $('#test_serial_number').val(sampleData.serial);
            $('#test_location').val(sampleData.location);
            $('#test_calibration_due_date').val(sampleData.calibration);
            $('#test_notes').val(sampleData.notes);

            // Check values after jQuery assignments
            debug('After jQuery assignments. Current values: ' + JSON.stringify(checkFormValues(), null, 2));

            // Force select element update
            const categorySelect = document.getElementById('test_category');
            for (let i = 0; i < categorySelect.options.length; i++) {
                if (categorySelect.options[i].value === sampleData.category) {
                    categorySelect.selectedIndex = i;
                    break;
                }
            }

            // Set QR button data
            document.getElementById('test_generateQRBtn').setAttribute('data-id', sampleData.id);

            // Final check
            debug('Final form state. Values: ' + JSON.stringify(checkFormValues(), null, 2));

            // Add a debug element to the modal
            setTimeout(() => {
                const modalBody = document.querySelector('#testEditModal .modal-body');
                if (modalBody) {
                    // Create debug info
                    const debugDiv = document.createElement('div');
                    debugDiv.className = 'alert alert-info mt-3';

                    // Get current values for display
                    const currentValues = checkFormValues();

                    debugDiv.innerHTML = `
                        <h5>Debug Information:</h5>
                        <p><strong>Original Data:</strong></p>
                        <pre>${JSON.stringify(sampleData, null, 2)}</pre>
                        <p><strong>Current Form Values:</strong></p>
                        <pre>${JSON.stringify(currentValues, null, 2)}</pre>
                    `;

                    // Add to modal
                    modalBody.appendChild(debugDiv);
                }
            }, 100);

            // Show modal
            var modal = new bootstrap.Modal(document.getElementById('testEditModal'));
            modal.show();

            // Check values when modal is fully shown
            document.getElementById('testEditModal').addEventListener('shown.bs.modal', function() {
                debug('Modal shown. Current form values: ' + JSON.stringify(checkFormValues(), null, 2));
            }, { once: true });

        } catch (error) {
            console.error('Error:', error);
            debug('Error: ' + error.message);
        }
    });
    
    // QR code generation from direct button
    document.getElementById('testQRBtn').addEventListener('click', function() {
        debug('QR button clicked');
        generateQRCode(sampleData);
    });
    
    // QR code generation from modal
    document.getElementById('test_generateQRBtn').addEventListener('click', function() {
        debug('Modal QR button clicked');
        
        // Get data from form fields
        const formData = {
            id: document.getElementById('test_id').value,
            manufacturer: document.getElementById('test_manufacturer').value,
            model: document.getElementById('test_model').value,
            serial: document.getElementById('test_serial_number').value
        };
        
        generateQRCode(formData);
    });
    
    // QR code generation function
    function generateQRCode(data) {
        // Show the QR code modal
        const qrModal = new bootstrap.Modal(document.getElementById('testQRModal'));
        qrModal.show();

        // Show loading state
        document.getElementById('testQRLoading').style.display = 'block';
        document.getElementById('testQRError').style.display = 'none';
        document.getElementById('testQRDisplay').style.display = 'none';
        document.getElementById('testQRDownloadBtn').style.display = 'none';
        document.getElementById('testQRPrintBtn').style.display = 'none';

        // Create URL for QR code
        const baseUrl = window.location.origin;
        const qrUrl = `${baseUrl}/qr/equipment/${data.id}`;
        debug(`QR URL: ${qrUrl}`);
        
        // Prepare data for QR generation
        const requestData = {
            url: qrUrl,
            equipment_id: data.id,
            manufacturer: data.manufacturer,
            model: data.model,
            serial: data.serial
        };

        debug(`Sending QR request: ${JSON.stringify(requestData)}`);

        // Make AJAX request to generate QR code
        fetch('/admin/equipment/generate-qr', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData),
        })
        .then(response => {
            debug(`Response status: ${response.status}`);
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            debug(`QR code generated: ${data.qr_code_url}`);
            
            // Hide loading, show QR code
            document.getElementById('testQRLoading').style.display = 'none';

            if (data.status === 'success') {
                document.getElementById('testQRDisplay').style.display = 'block';
                document.getElementById('testQRImage').src = data.qr_code_url;
                document.getElementById('testQREquipmentId').textContent = `Equipment ID: ${data.equipment_id}`;

                // Set download link
                const downloadBtn = document.getElementById('testQRDownloadBtn');
                downloadBtn.href = data.qr_code_url;
                downloadBtn.download = `qr_code_${data.equipment_id}.png`;
                downloadBtn.style.display = 'inline-block';

                // Show print button
                document.getElementById('testQRPrintBtn').style.display = 'inline-block';
            } else {
                document.getElementById('testQRError').textContent = data.message || 'Failed to generate QR code';
                document.getElementById('testQRError').style.display = 'block';
            }
        })
        .catch(error => {
            // Show error
            document.getElementById('testQRLoading').style.display = 'none';
            document.getElementById('testQRError').textContent = `Error: ${error.message}`;
            document.getElementById('testQRError').style.display = 'block';
            debug(`Error: ${error.message}`);
        });
    }
    
    // Print QR code
    document.getElementById('testQRPrintBtn').addEventListener('click', function() {
        const printWindow = window.open('', '_blank');
        const qrImage = document.getElementById('testQRImage').src;
        const equipmentId = document.getElementById('testQREquipmentId').textContent;

        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>QR Code - ${equipmentId}</title>
                <style>
                    body {
                        font-family: Arial, sans-serif;
                        text-align: center;
                        padding: 20px;
                    }
                    img {
                        max-width: 300px;
                        height: auto;
                    }
                    .container {
                        display: inline-block;
                        border: 1px solid #ccc;
                        padding: 20px;
                        margin: 10px;
                    }
                </style>
            </head>
            <body>
                <div class="container">
                    <img src="${qrImage}" alt="QR Code">
                    <div>
                        <p><strong>${equipmentId}</strong></p>
                        <p>Mary Bird Perkins Cancer Center</p>
                    </div>
                </div>
                <script>
                    window.onload = function() {
                        setTimeout(() => {
                            window.print();
                            setTimeout(() => {
                                window.close();
                            }, 100);
                        }, 500);
                    };
                </script>
            </body>
            </html>
        `);
        printWindow.document.close();
    });
});
</script>
{% endblock %}